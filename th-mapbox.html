<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../th-animated/th-animated.html">

<!--
Element providing the ability to create maps with the Mapbox API.

##### Example

      <th-mapbox 
          width="300" 
          height="450" 
          animateOnInit="true" 
          mapId="examples.map-i87786ca" 
          layers="[{'layerId': 'examples.bike-lanes'},{'layerId': 'examples.bike-locations'}]" 
          startingLat="38.8922" 
          startingLng="-77.0348"
      ></th-mapbox>

@element th-mapbox
@blurb Element providing the ability to create maps with the Mapbox API.
@status alpha
@homepage http://github.com/thelmanews/th-mapbox/demo.html
-->
<polymer-element name="th-mapbox" extends="th-animated" attributes="accessToken mapId width height layers geolocation geolocateZoom startingZoom startingLat startingLng showSwipeBar">

  <template>
    <link href='https://api.tiles.mapbox.com/mapbox.js/v2.1.2/mapbox.css' rel='stylesheet' />
    <link href='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-locatecontrol/v0.24.0/L.Control.Locate.css' rel='stylesheet' />
    <core-style ref="theme"></core-style>
    <style>
       #container {
        position: absolute;
        top:0;
       }
       #map { 
        position:relative; 
        top:0; 
        bottom:0;  
        width: 100%;
        height: 100%;
      }
      .swipearea {
        height: 50px;
        width: 100%;
        background-color: rgba(0,0,0,0.3);
        position: absolute;
        bottom: 0;
        left: 0;
        z-index: 1;
        text-align: center;
        padding: 15px;
        box-sizing: border-box;
        color: white;
      }
    </style>
    
    <div id="container" style="width: {{width}}px; height: {{height}}px;">
      <template if="{{showSwipeBar}}">
        <div class="swipearea submainpoint"> Swipe next here </div>
      </template>
      <div id='map'></div>
    </div>

  </template>
  <script src='https://api.tiles.mapbox.com/mapbox.js/v2.1.2/mapbox.js'></script> 
  <script src='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-locatecontrol/v0.24.0/L.Control.Locate.js'></script>

  <script>
    Polymer({
      accessToken: 'pk.eyJ1IjoidGhlbG1hIiwiYSI6Ikd3RUlsTTQifQ.i6bojdSBKd6JHENLKsRjTA', //TODO: replace and store in composer
      mapId: 'examples.map-i87786ca',
      layers: [],
      startingZoom: 12,
      startingLat: 38.8922,
      startingLng: -77.0348,
      geolocation: false,
      geolocateZoom: 10,
      showSwipeBar: true,
      width: 288,
      height: 503,
      ready: function() {
        var self = this,
            mapContainer = self.$.map;
        
        // Assign the access token
        L.mapbox.accessToken = self.accessToken;
        
        // Create the map inside the div, given the mapId, default lat/long and zoom
        self.map = L.mapbox.map(mapContainer, self.mapId);

        // If starting coordinates given, set view at that point
        if (self.startingLng && self.startingLng){
          self.map.setView([self.startingLat,self.startingLng], self.startingZoom); 
        }

        // Remove mapbox attribution/branding
        mapContainer.querySelector('.leaflet-control-attribution').remove();

        // Add layers to map
        for (var i=0; i<self.layers.length; i++){
          if(self.layers[i].layerId){
            L.mapbox.tileLayer(self.layers[i].layerId).addTo(self.map);
          }
        }

        // Add button for geolocation
        self.geolocate = L.control.locate({ locateOptions: { maxZoom: self.geolocateZoom }}).addTo(self.map);

      },
      animate: function(){
        var self = this;     
        if (self.geolocation){
          setTimeout(function(){
            self.geolocate.locate();  
          },2000)
          
        }
      },
      reset: function(){
        var self = this;
        if (self.startingLng && self.startingLng){
          self.map.setView([self.startingLat,self.startingLng], self.startingZoom); 
        }
      }

    });

  </script>

</polymer-element>
